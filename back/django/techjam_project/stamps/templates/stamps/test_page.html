<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»ã‚¯ãƒ¼ãƒãƒ³ ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; background-color: #f4f4f9; color: #333; }
        h1, h2 { color: #007bff; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin: 5px 0; }
        button:hover { background-color: #0056b3; }
        #message, .status-message { margin-top: 15px; padding: 10px; border-radius: 5px; }
        #message { background-color: #e2e3e5; color: #333; }
        .coupon-list-item { background-color: #ffffff; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .coupon-details { flex-grow: 1; }
        .coupon-details strong { font-size: 1.1em; color: #333; }
        .coupon-details span { display: block; font-size: 0.9em; color: #666; }
        .coupon-actions button { margin-left: 10px; }
        #couponMessage { background-color: #d4edda; color: #155724; font-weight: bold; }
        .stamp-info, .coupon-section { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #fff; }
        .error-message { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»ã‚¯ãƒ¼ãƒãƒ³æ©Ÿèƒ½ ãƒ†ã‚¹ãƒˆ</h1>

    <h2>ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ </h2>
    <div class="stamp-info">
        <strong>åº—èˆ—ID: </strong><span id="storeIdDisplay">{{ store.id|default:"ã‚¹ãƒˆã‚¢IDãªã—" }}</span>
        <button id="addStampBtn">ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ </button>
        <div id="message"></div>
        <div style="margin-top: 15px;">
            <strong>ç¾åœ¨ã®ã‚¹ã‚¿ãƒ³ãƒ—æ•°: </strong><span id="stampCount">0</span>
        </div>
        <div id="couponMessage"></div>
    </div>

    <h2>ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§</h2>
    <div class="coupon-section">
        <div id="couponList">
            <p>ã‚¯ãƒ¼ãƒãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>
    
    <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

    <script>
        const storeId = {{ store.id|default:"0" }};
        const csrfToken = document.getElementById("csrfToken").value;
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§ã‚’å–å¾—ãƒ»è¡¨ç¤º
        document.addEventListener("DOMContentLoaded", function() {
            fetchCoupons();
            fetchStampCount();
        });

        // ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function fetchStampCount() {
            // ã“ã“ã§ã¯ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’å–å¾—ã™ã‚‹å°‚ç”¨ã®APIãŒãªã„ãŸã‚ã€
            // ç°¡ç•¥åŒ–ã—ã¦ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’ç›´æ¥è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ã—ã¾ã™ã€‚
            // å®Ÿéš›ã«ã¯ã€ã‚¹ã‚¿ãƒ³ãƒ—æ•°å–å¾—ç”¨ã®APIãŒå¿…è¦ã§ã™ã€‚
        }

        // ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§ã‚’å–å¾—ãƒ»è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function fetchCoupons() {
            fetch(`/stamps/coupons/`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                return response.json();
            })
            .then(coupons => {
                const couponListDiv = document.getElementById("couponList");
                couponListDiv.innerHTML = ""; // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

                if (coupons.length === 0) {
                    couponListDiv.innerHTML = "<p>æœ‰åŠ¹æœŸé™å†…ã®ã‚¯ãƒ¼ãƒãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                    return;
                }

                coupons.forEach(coupon => {
                    const couponItem = document.createElement("div");
                    couponItem.className = "coupon-list-item";
                    couponItem.dataset.couponId = coupon.id;

                    const expiresAt = new Date(coupon.expires_at).toLocaleDateString('ja-JP');
                    
                    couponItem.innerHTML = `
                        <div class="coupon-details">
                            <strong>${coupon.description}</strong>
                            <span>æœ‰åŠ¹æœŸé™: ${expiresAt}</span>
                        </div>
                        <div class="coupon-actions">
                            <button class="use-coupon-btn">ä½¿ç”¨ã™ã‚‹</button>
                        </div>
                    `;
                    couponListDiv.appendChild(couponItem);
                });

                // å„ã€Œä½¿ç”¨ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                document.querySelectorAll(".use-coupon-btn").forEach(button => {
                    button.addEventListener("click", function(event) {
                        const couponId = event.target.closest(".coupon-list-item").dataset.couponId;
                        useCoupon(couponId);
                    });
                });
            })
            .catch(error => {
                const couponListDiv = document.getElementById("couponList");
                couponListDiv.innerHTML = `<p class="error-message">ã‚¯ãƒ¼ãƒãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            });
        }

        // ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹é–¢æ•°
        function useCoupon(couponId) {
            fetch(`/stamps/use-coupon/${couponId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                credentials: "same-origin"
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                fetchCoupons(); // ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§ã‚’å†å–å¾—ã—ã¦ç”»é¢ã‚’æ›´æ–°
            })
            .catch(error => {
                alert("ã‚¯ãƒ¼ãƒãƒ³ä½¿ç”¨ã‚¨ãƒ©ãƒ¼: " + error.message);
            });
        }

        // ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById("addStampBtn").addEventListener("click", function() {
            if (!storeId) {
                document.getElementById("message").innerText = "ã‚¹ãƒˆã‚¢IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
                return;
            }

            fetch(`/stamps/add-stamp/${storeId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                credentials: "same-origin"
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status} - ${JSON.stringify(errorData)}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("message").innerText = "ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ æˆåŠŸï¼";
                document.getElementById("stampCount").innerText = data.total_stamps;

                if (data.coupon) {
                    document.getElementById("couponMessage").innerHTML = 
                        `<div id="couponMessage"><p>ğŸ‰ ã‚¯ãƒ¼ãƒãƒ³ç™ºè¡Œï¼èª¬æ˜: ${data.coupon.description}</p></div>`;
                    fetchCoupons(); // æ–°ã—ã„ã‚¯ãƒ¼ãƒãƒ³ãŒç™ºè¡Œã•ã‚ŒãŸã‚‰ã€ä¸€è¦§ã‚’å†å–å¾—
                } else {
                    document.getElementById("couponMessage").innerHTML = "";
                }
            })
            .catch(error => {
                document.getElementById("message").innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + error.message;
            });
        });
    </script>
</body>
</html>